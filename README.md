# liflig-cdk-deployer

This represents a Docker image that will be run as a ECS task
to perform a deployment of AWS CDK stacks as part of a deployment
pipeline.

## How it works

The task requires a few files:

- A `cloud-assembly.json` file as described below, which includes a
  reference to a already synthesized CDK Cloud Assembly stored on S3
- A `variables*.json` files as described below containing variables
  that is combined with the parameters described in `cloud-assembly.json`
  to produce the parameters passed to CDK (and CloudFormation) during
  deployment.

The task will:

1. Identify the stacks for the current stage to be deployed
1. Download the Cloud Assembly
1. Build parameters to be used during deployemnt
1. Run CDK to deploy the stacks for the given Cloud Assembly

## The `cloud-assembly.json` file

Example:

```json
{
  "cloudAssemblyBucketName": "name-of-bucket",
  "cloudAssemblyBucketKey": "cloud-assembly/ff56fbd62edaa5d9112cd41d981a4bf966f088361b9c4eab7620389905390bd2.zip",
  "stages": [
    { "name": "dev", "stackNames": ["myapp-dev-core", "myapp-dev-api"] }
  ],
  "parameters": [
    {
      "name": "myapp-dev-api:EcrTag",
      "value": { "type": "variable", "variable": "apiEcrTag" }
    }
  ]
}
```

## The `variables*.json` files

These files will typically be generated by application repos and
contain variables used in the deployment. This allows the CDK code and
application code to be decoupled and not in the same repo.

Example:

```json
{
  "apiEcrTag": "some-tag-used-in-ecr"
}
```

## Environment variables

- CDK_DEPLOY_ROLE_ARN
- CDK_STAGE
- INPUT_DATA_DIR

## Limitations

CDK supports both embedded file (S3) and Docker (ECR) assets. Since we
run on Fargate, embedded Docker assets is not supported.
